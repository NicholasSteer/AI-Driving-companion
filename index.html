<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI GPS Companion Prototype</title>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Basic Reset */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }

        /* Map Container */
        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }
        
        /* AI Companion Interface */
        .ai-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            min-height: 200px;
            background-color: rgba(255, 255, 255, 0.95);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
        }

        .ai-response-box {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ai-text {
            font-size: 18px;
            color: #333;
            text-align: center;
        }

        .mic-button {
            background-color: #007BFF;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            border: 4px solid rgba(0, 123, 255, 0.3);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .mic-button.active {
            background-color: #E84A5F;
            border-color: rgba(232, 74, 95, 0.3);
        }

        .mic-button i {
            font-size: 28px;
            color: white;
        }

        .mic-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="ai-container">
        <div class="ai-response-box">
            <p id="ai-text">Hello! Please allow location access, then tell me where you want to go.</p>
        </div>
        <button id="mic-btn" class="mic-button">
            <i class="fa-solid fa-microphone"></i>
        </button>
        <p id="mic-label" class="mic-label">Tap to Speak</p>
    </div>

    <script>
        // --- API Keys ---
        const GEMINI_API_KEY = "AIzaSyDa2G1Bq7jWg34Ox25bWfN5Tn2dbtU4G4Y"; // IMPORTANT: Add your Gemini API key here
        const Maps_API_KEY = "AIzaSyCzgXyF0StCO_G64eG75LuZugiec0vbzoo"; // IMPORTANT: Add your Google Maps API key here

        // --- DOM Elements ---
        const aiTextElement = document.getElementById('ai-text');
        const micButton = document.getElementById('mic-btn');
        const micLabel = document.getElementById('mic-label');

        // --- State Variables & Google Maps Services ---
        let map;
        let userMarker;
        let isListening = false;
        let userLocation = null;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        let locationWatcherId;
        
        const initialCoords = { lat: -33.9249, lng: 18.4241 };

        // --- Text-to-Speech (TTS) Setup ---
        const synth = window.speechSynthesis;
        
        function speak(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            aiTextElement.textContent = text;
            synth.speak(utterance);
        }

        // --- Google Maps Initialization ---
        // This function is now a global callback accessible by the Google Maps script
        window.getLocation = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        initMapWithLocation({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    () => {
                        speak("Could not get your location. Using default.");
                        initMapWithLocation(initialCoords);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                speak("Geolocation is not supported.");
                initMapWithLocation(initialCoords);
            }
        }

        function initMapWithLocation(coords) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: coords,
                zoom: 16,
                mapTypeControl: false,
                streetViewControl: false,
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            geocoder = new google.maps.Geocoder();
            directionsRenderer.setMap(map); 

            userLocation = coords;
            userMarker = new google.maps.Marker({
                position: coords,
                map: map,
                title: "You are here!",
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 7,
                    rotation: 0,
                    fillColor: "#4285F4",
                    fillOpacity: 1,
                    strokeColor: "white",
                    strokeWeight: 2,
                },
            });
            speak("Your location is set. Where would you like to go?");
            startWatchingLocation();
        }

        // --- Real-Time Location Tracking ---
        function startWatchingLocation() {
            if (locationWatcherId) {
                navigator.geolocation.clearWatch(locationWatcherId);
            }
            locationWatcherId = navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    if (userMarker) {
                        userMarker.setPosition(userLocation);
                        map.panTo(userLocation);
                    }
                },
                (error) => {
                    console.error("Error watching position: ", error);
                    let errorMessage = "I'm having trouble tracking your live location. Please check your device's settings and permissions.";
                    if (error.code === error.TIMEOUT) {
                        errorMessage = "Could not get your location in time. Please try again in an area with a clearer signal.";
                    }
                    speak(errorMessage);
                    if (locationWatcherId) {
                       navigator.geolocation.clearWatch(locationWatcherId);
                    }
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000,
                }
            );
        }
        
        // --- Navigation and Routing ---
        function calculateAndDisplayRoute(destination) {
            if (!userLocation) {
                speak("I can't calculate a route without your location.");
                return;
            }
            if (userMarker) userMarker.setMap(null);

            directionsService.route({
                origin: userLocation,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            })
            .then((response) => {
                directionsRenderer.setDirections(response);
                const routeInfo = response.routes[0].legs[0];
                const firstStep = routeInfo.steps[0].instructions.replace(/<[^>]*>/g, "");
                speak(`Starting route to ${routeInfo.end_address}. Your first instruction is: ${firstStep}`);
                
                setTimeout(() => {
                    handleConversation("Give me a friendly greeting for the start of my drive.");
                }, 10000);
            })
            .catch((e) => {
                speak("Sorry, I could not calculate a route for that destination.");
                if(userMarker) userMarker.setMap(map);
            });
        }
        
        // --- Voice Interaction Logic ---
        async function handleConversation(command) {
            if (!GEMINI_API_KEY) {
                speak("The AI companion is not configured. An API key is needed.");
                return;
            }
            speak("Thinking...");
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{
                    parts: [{ "text": `You are a friendly and helpful AI driving companion. Keep your answers concise and cheerful. User says: "${command}"` }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                speak(text);
            } catch (error) {
                console.error("Gemini API error:", error);
                speak("I'm having a little trouble thinking right now. Please try again later.");
            }
        }
        
        function handleLocationShare(command) {
            const phoneNumberMatch = command.match(/\d+/g);
            if (!phoneNumberMatch || !userLocation) {
                speak("Please say a phone number and make sure location is active to share.");
                return;
            }
            const phoneNumber = phoneNumberMatch.join("");
            const mapsLink = `https://www.google.com/maps?q=${userLocation.lat},${userLocation.lng}`;
            const message = encodeURIComponent(`Hi! I'm sharing my current location with you: ${mapsLink}`);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;

            speak(`Okay, I'm opening WhatsApp to share your location with ${phoneNumber}.`);
            window.open(whatsappUrl, '_blank');
        }

        function processUserCommand(command) {
            const lowerCaseCommand = command.toLowerCase();
            if (lowerCaseCommand.startsWith("drive to") || lowerCaseCommand.startsWith("navigate to")) {
                const destinationName = command.replace(/^(drive to|navigate to)\s*/i, '').trim();
                speak(`Searching for ${destinationName}`);
                geocoder.geocode({ 'address': destinationName })
                    .then(({ results }) => {
                        if (results[0]) {
                            calculateAndDisplayRoute(results[0].geometry.location);
                        } else {
                            speak(`Sorry, I couldn't find a location called "${destinationName}".`);
                        }
                    }).catch(() => speak("There was an error finding that location."));
            } else if (lowerCaseCommand.startsWith("share my location with")) {
                handleLocationShare(command);
            } else {
                handleConversation(command);
            }
        }
        
        // --- Web Speech API Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript;
                processUserCommand(command);
            };

            recognition.onspeechend = () => {
                isListening = false;
                micButton.classList.remove('active');
                micLabel.textContent = 'Tap to Speak';
            };
            
            recognition.onerror = (event) => {
                if(event.error !== 'no-speech') {
                   speak('Sorry, a voice recognition error occurred.');
                }
                isListening = false;
                micButton.classList.remove('active');
                micLabel.textContent = 'Tap to Speak';
            };
        } else {
            micButton.disabled = true;
            micLabel.textContent = "Voice not supported";
        }

        micButton.addEventListener('click', () => {
            if (!SpeechRecognition) return;
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    synth.cancel(); 
                    recognition.start();
                    isListening = true;
                    micButton.classList.add('active');
                    micLabel.textContent = 'Listening...';
                    aiTextElement.textContent = "I'm listening...";
                } catch(e) {
                    aiTextElement.textContent = "Could not start voice recognition.";
                }
            }
        });

        // --- Dynamically Load Google Maps Script ---
        function loadGoogleMapsScript() {
            if (!Maps_API_KEY) {
                speak("Google Maps API key is missing. The map cannot be loaded.");
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${Maps_API_KEY}&callback=getLocation`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        // Start the app
        loadGoogleMapsScript();

    </script>
</body>
</html>
