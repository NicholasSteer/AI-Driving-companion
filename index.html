<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI GPS Companion Prototype</title>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Basic Reset */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }

        /* Map Container */
        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }
        
        /* AI Companion Interface */
        .ai-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            min-height: 200px;
            background-color: rgba(255, 255, 255, 0.95);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
        }

        .ai-response-box {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ai-text {
            font-size: 18px;
            color: #333;
            text-align: center;
        }

        .mic-button {
            background-color: #007BFF;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            border: 4px solid rgba(0, 123, 255, 0.3);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .mic-button.active {
            background-color: #E84A5F;
            border-color: rgba(232, 74, 95, 0.3);
        }

        .mic-button i {
            font-size: 28px;
            color: white;
        }

        .mic-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="ai-container">
        <div class="ai-response-box">
            <p id="ai-text">Hello! Please allow location access, then tell me where you want to go.</p>
        </div>
        <button id="mic-btn" class="mic-button">
            <i class="fa-solid fa-microphone"></i>
        </button>
        <p id="mic-label" class="mic-label">Tap to Speak</p>
    </div>

    <script>
        // --- DOM Elements ---
        const aiTextElement = document.getElementById('ai-text');
        const micButton = document.getElementById('mic-btn');
        const micLabel = document.getElementById('mic-label');

        // --- State Variables & Google Maps Services ---
        let map;
        let userMarker;
        let isListening = false;
        let userLocation = null;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        
        // Initial location: Cape Town, South Africa
        const initialCoords = { lat: -33.9249, lng: 18.4241 };

        // --- Google Maps Initialization ---
        function initMapWithLocation(coords) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: coords,
                zoom: 14,
                mapTypeControl: false,
                streetViewControl: false,
            });

            // Initialize Google Maps services
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            geocoder = new google.maps.Geocoder();
            directionsRenderer.setMap(map); // Link renderer to the map

            userLocation = coords;
            userMarker = new google.maps.Marker({
                position: coords,
                map: map,
                title: "You are here!",
            });
            aiTextElement.textContent = "Your location is set. Where would you like to go?";
        }

        // --- Location Tracking ---
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        initMapWithLocation(coords);
                    },
                    () => {
                        aiTextElement.textContent = "Could not get your location. Showing default map.";
                        initMapWithLocation(initialCoords);
                    }
                );
            } else {
                aiTextElement.textContent = "Geolocation is not supported. Showing default map.";
                initMapWithLocation(initialCoords);
            }
        }
        
        // --- Navigation and Routing ---
        function calculateAndDisplayRoute(destination) {
            if (!userLocation) {
                aiTextElement.textContent = "I can't calculate a route without your location.";
                return;
            }

            directionsService.route({
                origin: userLocation,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            })
            .then((response) => {
                directionsRenderer.setDirections(response);
                // Clear the initial user marker as the route has its own start marker
                if (userMarker) userMarker.setMap(null);
                const routeInfo = response.routes[0].legs[0];
                aiTextElement.textContent = `Route to ${routeInfo.end_address}. Duration: ${routeInfo.duration.text}.`;
            })
            .catch((e) => {
                window.alert("Directions request failed due to " + e);
                aiTextElement.textContent = "Sorry, I could not calculate a route for that destination.";
            });
        }
        
        // --- Voice Interaction Logic ---
        function processUserCommand(command) {
            if (command.toLowerCase().startsWith("drive to")) {
                const destinationName = command.substring("drive to".length).trim();
                aiTextElement.textContent = `Searching for "${destinationName}"...`;
                
                // Use Geocoder to find coordinates for the destination name
                geocoder.geocode({ 'address': destinationName })
                .then(({ results }) => {
                    if (results[0]) {
                        calculateAndDisplayRoute(results[0].geometry.location);
                    } else {
                        window.alert("No results found for " + destinationName);
                        aiTextElement.textContent = `Sorry, I couldn't find a location called "${destinationName}".`;
                    }
                })
                .catch((e) => {
                    window.alert("Geocoder failed due to: " + e);
                    aiTextElement.textContent = "There was an error finding that location.";
                });

            } else {
                aiTextElement.textContent = `I heard: "${command}". Try saying "Drive to Table Mountain."`;
            }
        }
        
        // --- Web Speech API Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript;
                processUserCommand(command);
            };

            recognition.onspeechend = () => {
                recognition.stop();
                isListening = false;
                micButton.classList.remove('active');
                micLabel.textContent = 'Tap to Speak';
            };
            
            recognition.onerror = (event) => {
                aiTextElement.textContent = 'Error with voice recognition: ' + event.error;
                isListening = false;
                micButton.classList.remove('active');
                micLabel.textContent = 'Tap to Speak';
            };

        } else {
            micButton.disabled = true;
            micLabel.textContent = "Voice not supported";
            aiTextElement.textContent = "Sorry, your browser doesn't support voice commands.";
        }

        micButton.addEventListener('click', () => {
            if (!SpeechRecognition) return;
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    isListening = true;
                    micButton.classList.add('active');
                    micLabel.textContent = 'Listening...';
                    aiTextElement.textContent = "I'm listening... Speak now.";
                } catch(e) {
                    aiTextElement.textContent = "Could not start voice recognition.";
                }
            }
        });

    </script>
    <!-- IMPORTANT: Replace YOUR_Maps_API_KEY with your actual API key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzgXyF0StCO_G64eG75LuZugiec0vbzoo&callback=getLocation"></script>
</body>
</html>
